<?php

namespace App\Http\Controllers\Api;

use App\Enums\LeadStatusEnum;
use App\Enums\NotificationTypeEnum;
use App\Enums\SettingKeyEnum;
use App\Enums\WhatsappMessageTemplateEnum;
use App\Events\WhatsappNotificationEvent;
use App\Http\Controllers\Controller;
use App\Models\Fblead;
use App\Models\User;
use App\Models\Contract;
use App\Models\Job;
use App\Jobs\SendMeetingMailJob;
use App\Models\Offer;
use App\Models\WorkerWebhookResponse;
use App\Models\WhatsAppBotWorkerState;
use App\Models\Notification;
use App\Models\Setting;
use App\Models\WorkerLeads;
use Carbon\Carbon;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Cache;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Str;


class WorkerLeadWebhookController extends Controller
{

    protected $botMessages = [
        'step0' => [
            'en' => "ðŸŒŸ Thank you for contacting Job4Service! ðŸŒŸ\n\nWe are hiring house cleaning professionals for part-time and full-time positions in the Tel Aviv area.\n\nâœ… To apply, you must have one of the following:\n- Israeli ID\n- B1 Work Visa\n- Refugee (blue) visa\n\nPlease answer these two questions to proceed:\n1. Do you have experience in house cleaning?\n(Please reply with 'Yes' or 'No')",
            'ru' => "ðŸŒŸ Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾, Ñ‡Ñ‚Ð¾ ÑÐ²ÑÐ·Ð°Ð»Ð¸ÑÑŒ Ñ Job4Service! ðŸŒŸ\n\nÐœÑ‹ Ð¸Ñ‰ÐµÐ¼ ÑÐ¾Ñ‚Ñ€ÑƒÐ´Ð½Ð¸ÐºÐ¾Ð² Ð´Ð»Ñ ÑƒÐ±Ð¾Ñ€ÐºÐ¸ Ð´Ð¾Ð¼Ð¾Ð² Ð½Ð° Ð¿Ð¾Ð»Ð½ÑƒÑŽ Ð¸ Ñ‡Ð°ÑÑ‚Ð¸Ñ‡Ð½ÑƒÑŽ Ð·Ð°Ð½ÑÑ‚Ð¾ÑÑ‚ÑŒ Ð² Ñ€Ð°Ð¹Ð¾Ð½Ðµ Ð¢ÐµÐ»ÑŒ-ÐÐ²Ð¸Ð²Ð°.\nâœ… Ð”Ð»Ñ Ð¿Ð¾Ð´Ð°Ñ‡Ð¸ Ð·Ð°ÑÐ²ÐºÐ¸ Ñƒ Ð²Ð°Ñ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ Ð¾Ð´Ð¸Ð½ Ð¸Ð· ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ð¾Ð²:\n- Ð˜Ð·Ñ€Ð°Ð¸Ð»ÑŒÑÐºÐ¾Ðµ ÑƒÐ´Ð¾ÑÑ‚Ð¾Ð²ÐµÑ€ÐµÐ½Ð¸Ðµ Ð»Ð¸Ñ‡Ð½Ð¾ÑÑ‚Ð¸\n- Ð Ð°Ð±Ð¾Ñ‡Ð°Ñ Ð²Ð¸Ð·Ð° B1\n- Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð±ÐµÐ¶ÐµÐ½Ñ†Ð° (ÑÐ¸Ð½ÑÑ Ð²Ð¸Ð·Ð°)\n\nÐžÑ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ, Ð¿Ð¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð½Ð° Ð´Ð²Ð° Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ°:\n1. Ð£ Ð²Ð°Ñ ÐµÑÑ‚ÑŒ Ð¾Ð¿Ñ‹Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¿Ð¾ ÑƒÐ±Ð¾Ñ€ÐºÐµ Ð´Ð¾Ð¼Ð¾Ð²?\n(ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ \"Ð”Ð°\" Ð¸Ð»Ð¸ \"ÐÐµÑ‚\" Ð½Ð° ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ.)",
       ],
        'step1' => [
            'en' => "We didnâ€™t quite understand your answer.\n\nâœ… Please respond clearly with:\n\n1. \"Yes\" or \"No\" â€“ Do you have experience in house cleaning?\n\nLetâ€™s continue when youâ€™re ready! ðŸ˜Š",
            'ru' => "ÐœÑ‹ Ð½Ðµ ÑÐ¾Ð²ÑÐµÐ¼ Ð¿Ð¾Ð½ÑÐ»Ð¸ Ð²Ð°Ñˆ Ð¾Ñ‚Ð²ÐµÑ‚.\n\nâœ… ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ Ñ‡ÐµÑ‚ÐºÐ¾:\n\n1. \"Ð”Ð°\" Ð¸Ð»Ð¸ \"ÐÐµÑ‚\" â€“ Ð•ÑÑ‚ÑŒ Ð»Ð¸ Ñƒ Ð²Ð°Ñ Ð¾Ð¿Ñ‹Ñ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¿Ð¾ ÑƒÐ±Ð¾Ñ€ÐºÐµ?\n\nÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ð¼, ÐºÐ°Ðº Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ñ‹ Ð±ÑƒÐ´ÐµÑ‚Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹! ðŸ˜Š  ",
        ],
        'step2' => [
            'en' => "2. Do you have a valid visa or ID as mentioned above?\n(Please reply with 'Yes' or 'No')",
            'ru' => "2. Ð£ Ð²Ð°Ñ ÐµÑÑ‚ÑŒ Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÑŽÑ‰Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‡Ð°Ñ Ð²Ð¸Ð·Ð° Ð¸Ð»Ð¸ ÑƒÐ´Ð¾ÑÑ‚Ð¾Ð²ÐµÑ€ÐµÐ½Ð¸Ðµ Ð»Ð¸Ñ‡Ð½Ð¾ÑÑ‚Ð¸?\n(ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ \"Ð”Ð°\" Ð¸Ð»Ð¸ \"ÐÐµÑ‚\" Ð½Ð° ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ.)",
        ],
        'step3' => [
            'en' => "We didnâ€™t quite understand your answer.\n\nâœ… Please respond clearly with:\n\n2. \"Yes\" or \"No\" â€“ Do you have a valid work visa (Israeli ID, B1 visa, or refugee visa)?\n\nLetâ€™s continue when youâ€™re ready! ðŸ˜Š",
            'ru' => "ÐœÑ‹ Ð½Ðµ ÑÐ¾Ð²ÑÐµÐ¼ Ð¿Ð¾Ð½ÑÐ»Ð¸ Ð²Ð°Ñˆ Ð¾Ñ‚Ð²ÐµÑ‚.\n\nâœ… ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¾Ñ‚Ð²ÐµÑ‚ÑŒÑ‚Ðµ Ñ‡ÐµÑ‚ÐºÐ¾:\n\n2. \"Ð”Ð°\" Ð¸Ð»Ð¸ \"ÐÐµÑ‚\" â€“ Ð•ÑÑ‚ÑŒ Ð»Ð¸ Ñƒ Ð²Ð°Ñ Ð´ÐµÐ¹ÑÑ‚Ð²ÑƒÑŽÑ‰Ð°Ñ Ñ€Ð°Ð±Ð¾Ñ‡Ð°Ñ Ð²Ð¸Ð·Ð° (Ð¸Ð·Ñ€Ð°Ð¸Ð»ÑŒÑÐºÐ¾Ðµ ÑƒÐ´Ð¾ÑÑ‚Ð¾Ð²ÐµÑ€ÐµÐ½Ð¸Ðµ, Ð²Ð¸Ð·Ð° B1 Ð¸Ð»Ð¸ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð±ÐµÐ¶ÐµÐ½Ñ†Ð°)?\n\nÐŸÑ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ð¼, ÐºÐ°Ðº Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ñ‹ Ð±ÑƒÐ´ÐµÑ‚Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹! ðŸ˜Š",
        ],
    ];

    public function fbWebhookCurrentLive(Request $request)
    {
        $get_data = $request->getContent();
        $data_returned = json_decode($get_data, true);
        $messageId = $data_returned['messages'][0]['id'] ?? null;
        $lng = "en";

        if (!$messageId) {
            return response()->json(['status' => 'Invalid message data'], 400);
        }

        // Check if the messageId exists in cache and matches
        if (Cache::get('processed_message_' . $messageId) === $messageId) {
            \Log::info('Already processed');
            return response()->json(['status' => 'Already processed'], 200);
        }

        // Store the messageId in the cache for 1 hour
        Cache::put('processed_message_' . $messageId, $messageId, now()->addHours(1));

        if (
            isset($data_returned['messages']) &&
            isset($data_returned['messages'][0]['from_me']) &&
            $data_returned['messages'][0]['from_me'] == false
        ) {
            $message_data = $data_returned['messages'];
            $from = $message_data[0]['from'];
            $input = $data_returned['messages'][0]['text']['body'];
            $lng = $this->detectLanguage($input);
            $currentStep = 0;

            WorkerWebhookResponse::create([
                'status' => 1,
                'name' => 'whatsapp',
                'entry_id' => (isset($get_data['entry'][0])) ? $get_data['entry'][0]['id'] : '',
                'message' => $data_returned['messages'][0]['text']['body'],
                'number' => $from,
                'read' => 0,
                'flex' => 'W',
                'data' => json_encode($get_data)
            ]);

            $workerLead = WorkerLeads::where('phone', $from)->first();

            if (!$workerLead) {
                $workerLead = WorkerLeads::create([
                    'phone' => $from,
                    'lng' => $lng
                ]);
                WhatsAppBotWorkerState::updateOrCreate(
                    ['worker_lead_id' => $workerLead->id],
                    ['step' => 0, 'language' => $lng]
                );
                // Send the step0 message
                $initialMessage = $this->botMessages['step0'][$lng];
                $result = sendWorkerWhatsappMessage($from, ['name' => '', 'message' => $initialMessage]);
                // Save the admin message for step0
                WorkerWebhookResponse::create([
                    'status' => 1,
                    'name' => 'whatsapp',
                    'message' => $initialMessage,
                    'number' => $from,
                    'read' => 1,
                    'flex' => 'A',
                ]);
                return;
            }

            if (Str::endsWith($message_data[0]['chat_id'], '@g.us')) {
                $messageInput = strtolower(trim($input));
                // Check if the message follows the format "phone â€“ status"
                if (preg_match('/^\+?\d+\s*[-â€“]\s*(hire|no|unanswered|×œ×œ× ×ž×¢× ×”|×œÖ´×©×‚Ö°×›Ö¼×•Ö¹×¨|×œÖ¹×)$/i', $messageInput, $matches) && ($message_data[0]['chat_id'] == config('services.whatsapp_groups.relevant_with_workers'))) {
                    $phoneNumber = trim(explode('-', $matches[0])[0]); // Extracts the number
                    $statusInput = strtolower($matches[1]); // Extracts the status

                    // Find the workerLead based on the phone number
                    $workerLead = WorkerLeads::where('phone', $phoneNumber)->first();

                    if ($workerLead) {
                        // Determine the status
                        if (in_array($statusInput, ['hire', '×œÖ´×©×‚Ö°×›Ö¼×•Ö¹×¨'])) {
                            $workerLead->status = "hiring";
                        } elseif (in_array($statusInput, ['unanswered', '×œ×œ× ×ž×¢× ×”'])) {
                            $workerLead->status = "unanswered";
                        } else {
                            $workerLead->status = "not-hired";
                        }

                        $workerLead->save();

                        // Send appropriate WhatsApp message
                        if ($workerLead->status == "hiring") {
                            $this->sendWhatsAppMessage($workerLead, WhatsappMessageTemplateEnum::NEW_LEAD_HIRIED_TO_TEAM);
                        } elseif ($workerLead->status == "not-hired") {
                            $this->sendWhatsAppMessage($workerLead, WhatsappMessageTemplateEnum::FINAL_MESSAGE_IF_NO_TO_LEAD);
                        } else {
                            $this->sendWhatsAppMessage($workerLead, WhatsappMessageTemplateEnum::NEW_LEAD_HIRING_ALEX_REPLY_UNANSWERED);
                        }
                        return response()->json(['status' => 'Worker status updated'], 200);
                    }

                    return response()->json(['status' => 'Worker not found'], 404);
                }

                return response()->json(['status' => 'Message format invalid or already processed'], 400);
            }


            $workerState = WhatsAppBotWorkerState::where("worker_lead_id", $workerLead->id)->first();

            if ($workerState && $workerState->step == 4) {
                // Conversation is complete, no further processing
                return response()->json(['status' => 'Conversation complete'], 200);
            }

            if (in_array($input, [1, 2])) {
                $languageMap = [1 => 'en', 2 => 'ru'];
                $lng = $languageMap[$input];

                WhatsAppBotWorkerState::updateOrCreate(
                    ['worker_lead_id' => $workerLead->id],
                    ['step' => 0, 'language' => $lng]
                );
                WorkerLeads::updateOrCreate(
                    ['id' => $workerLead->id],
                    ['lng' => $lng]
                );

                $switchMessage = $this->botMessages['step0'][$lng];
                $result = sendWorkerWhatsappMessage($from, ['name' => '', 'message' => $switchMessage]);

                WorkerWebhookResponse::create([
                    'status' => 1,
                    'name' => 'whatsapp',
                    'message' => $switchMessage,
                    'number' => $from,
                    'read' => 1,
                    'flex' => 'A',
                ]);

                return;
            }else{
                // Process user response based on current step
                $currentStep = $workerState->step;
                $nextMessage = $this->processWorkerResponse($workerLead, $input, $currentStep, $workerState->language);

                $lastMessageSent = WorkerWebhookResponse::where('number', $workerLead->phone)
                ->where('read',1)
                ->orderBy('created_at', 'desc')
                ->first()->message ?? '';

                if ($nextMessage) {
                    // Send the next step message
                    $result = sendWorkerWhatsappMessage($from, ['name' => '', 'message' => $nextMessage]);
                    $acceptedResponses = ['yes', 'Ð´Ð°', 'no', 'Ð½ÐµÑ‚', 'ÐÐµÑ‚'];

                    // Normalize the user input
                    $normalizedInput = strtolower(trim($input));

                    // Check if the input is valid and not the same as the last message
                    if (($nextMessage != $lastMessageSent) && in_array($normalizedInput, $acceptedResponses)) {
                        // Update the current step in the state
                        WhatsAppBotWorkerState::updateOrCreate(
                            ['worker_lead_id' => $workerLead->id],
                            ['step' => $currentStep + 1]
                        );
                    }
                    // Save admin message for next step
                    WorkerWebhookResponse::create([
                        'status' => 1,
                        'name' => 'whatsapp',
                        'message' => $nextMessage,
                        'number' => $from,
                        'read' => 1,
                        'flex' => 'A',
                    ]);
                }
            }
        }
    }

    protected function processWorkerResponse($workerLead, $input, $currentStep,$language)
    {
        $messages = $this->botMessages;
        $lng = $language;
        $response = strtolower(trim($input));

        switch ($currentStep) {
            case 0:
                if (in_array($response, ['yes', 'sÃ­', 'Ð”Ð°', '×›Ö¼Öµ×Ÿ'])) {
                    $workerLead->experience_in_house_cleaning = true;
                    $workerLead->save();
                    return $messages['step2'][$lng];
                } elseif (in_array($response, ['no', 'No', 'ÐÐµÑ‚', '×œ×'])) {
                    $workerLead->experience_in_house_cleaning = false;
                    $workerLead->save();
                    return $messages['step2'][$lng];
                } else {
                    return $messages['step1'][$lng];
                }

            case 1:
                if (in_array($response, ['yes', 'sÃ­', 'Ð”Ð°','×›Ö¼Öµ×Ÿ'])) {
                    $workerLead->you_have_valid_work_visa = true;
                    $workerLead->save();
                    return $this->sendMessageToTeamOrLead($workerLead, $input);
                } elseif (in_array($response, ['no', 'No', 'ÐÐµÑ‚', '×œ×'])) {
                    $workerLead->you_have_valid_work_visa = false;
                    $workerLead->save();
                    return $this->sendMessageToTeamOrLead($workerLead, $input);
                } else {
                    return $messages['step3'][$lng];
                }

            case 2:
               $this->sendMessageToTeamOrLead($workerLead, $input);
        }
    }

    protected function sendMessageToTeamOrLead($workerLead, $input)
       {
           if ( $workerLead->you_have_valid_work_visa ) {

                $this->sendWhatsAppMessage($workerLead, WhatsappMessageTemplateEnum::NEW_LEAD_FOR_HIRING_TO_TEAM);

                WhatsAppBotWorkerState::updateOrCreate(
                    ['worker_lead_id' => $workerLead->id],
                    ['step' => 4]
                );

           } else {
                $workerLead = WorkerLeads::find($workerLead->id);
                $workerLead->status = "not-hired";
                $workerLead->save();

               $resp = $this->sendWhatsAppMessage($workerLead, WhatsappMessageTemplateEnum::FINAL_MESSAGE_IF_NO_TO_LEAD);

               WhatsAppBotWorkerState::updateOrCreate(
                   ['worker_lead_id' => $workerLead->id],
                   ['step' => 4]
               );

           }

       }


    public function detectLanguage($text)
    {
        // Regex for Russian (Cyrillic)
        if (preg_match('/[\x{0400}-\x{04FF}]/u', $text)) {
            return 'ru';
        } else {
            return 'en';
        }
    }

    protected function sendWhatsAppMessage($workerLead, $enum)
    {
       event(new WhatsappNotificationEvent([
            "type" => $enum,
            "notificationData" => [
                'worker' => $workerLead->toArray(),
            ]
        ]));
    }

}
